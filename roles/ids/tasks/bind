---

- name: 20.04 & later
  block:
  - name: bind with script
    template:
      src: vfio.sh
      dest: /etc/initramfs-tools/scripts/init-top/vfio.sh
      owner: root
      mode: '0555'

  - name: bind modules
    lineinfile:
      path: /etc/initramfs-tools/modules
      line: 'options kvm ignore_msrs=1'
    notify: update initramfs

  - debug:
      msg: 'From inside block!'
  become: true
  when: ansible_distribution_major_version in later_os


- name: 19.04 & earlie
  block:
  - name: bind with conf file
    blockinfile:
      path: /etc/modprobe.d/vfio.conf
      create: yes
      block: |
        options vfio-pci ids={{ vfio_ids }}
    notify:
      - update initramfs
      - dracut regenerate
  become: true
  when: ansible_distribution_release in earlier_os
